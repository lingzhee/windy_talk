<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>聊天室</title>
</head>
<style>
    .maindiv{
        text-align:center;
        width: 500px;
    }
</style>
<body>
    <div class="maindiv">
        <div style="text-align: left">
            <div  id="content"></div>

            <input id="msg"/><button onclick="send();">send</button>
            <br/><br/><br/>
            <hr/>
            <div id="userList"></div>
        </div>
    </div>
</body>
<script type="text/javascript" src="jquery-1.8.3.min.js"></script>
<script>
    //获取当前登录用户名
    var username;
    $.ajax({
        url:"/getName",
        async: false,
        contentType: 'text/json,charset=utf-8',
        success: function (data) {
            username=data;
        }
    });

    var ws;
    var target = "ws://"+window.location.host+"/chatSocket?username="+username;
    window.onload=function (){
        //进入聊天页面就打开websocket链接

        if (ws!=null) {
            return ws;
        }else{
            ws = new WebSocket(target);
        }
        //收到消息的回调
        ws.onmessage = function (data){
            //console.info(data);
            var msg = eval("("+data.data+")");
            if (msg.message!=undefined) {
                $('#content').append(msg.message);
            }
            if (msg.welcome!=undefined) {
                $('#content').append(msg.welcome);

            }
            if(msg.userNames!=undefined){
                $("#userList").html('');
                $(msg.userNames).each(function () {
                    $("#userList").append("<input type='checkbox' value='"+this+"'/>"+this+"<br/>");
                });
            }

        }

    }

    function send(){
        var obj;
        var checkbox = $("#userList :checked");
        var msg = document.getElementById("msg").value;//说的内容
        var to = checkbox.val(); //私聊的人
        if(checkbox.size()>0){
            obj = {
                to:to,
                msg:msg,
                type:1
            }
        } else {
            obj = {
                msg:msg,
                type:0
            }
        }
        //发送到服务器的内容
        var sendStr = JSON.stringify(obj);
        ws.send(sendStr);
        /* 	var msg = document.getElementById("msg");
            ws.send(msg.value);
            msg.value=""; */
    }

    //退出页面时关闭ws对象
    window.onunload = function() {
        ws.close();
    }


    //按回车发送信息
    document.onkeyup = function(e) {
        // 兼容FF和IE和Opera
        var event = e || window.event;
        var key = event.which || event.keyCode || event.charCode;
        if (key == 13) {
            send()
        }
    };
</script>
</html>
